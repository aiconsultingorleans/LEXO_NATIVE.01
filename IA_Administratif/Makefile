# LEXO v1 - Makefile
# Assistant IA pour la gestion administrative intelligente

.PHONY: help setup-dev install clean start stop restart logs test lint format build deploy

# Variables
COMPOSE_FILE = docker-compose.yml
BACKEND_DIR = backend
FRONTEND_DIR = frontend

# Colors for output
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

help: ## Affiche l'aide
	@echo "$(BLUE)LEXO v1 - Commandes disponibles:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

setup-dev: ## Configuration initiale de l'environnement de dÃ©veloppement
	@echo "$(BLUE)ðŸ”§ Configuration de l'environnement de dÃ©veloppement...$(NC)"
	@cp .env.example .env || echo "$(YELLOW)âš ï¸  .env dÃ©jÃ  existant$(NC)"
	@cp $(FRONTEND_DIR)/.env.example $(FRONTEND_DIR)/.env.local || echo "$(YELLOW)âš ï¸  .env.local dÃ©jÃ  existant$(NC)"
	@echo "$(GREEN)âœ… Environnement configurÃ©$(NC)"

install: ## Installation des dÃ©pendances
	@echo "$(BLUE)ðŸ“¦ Installation des dÃ©pendances...$(NC)"
	@cd $(BACKEND_DIR) && python -m venv venv && source venv/bin/activate && pip install -r requirements.txt
	@cd $(FRONTEND_DIR) && npm install
	@echo "$(GREEN)âœ… DÃ©pendances installÃ©es$(NC)"

clean: ## Nettoyage des fichiers temporaires
	@echo "$(BLUE)ðŸ§¹ Nettoyage...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) down -v --remove-orphans
	@docker system prune -f
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true
	@rm -rf $(FRONTEND_DIR)/.next
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

start: ## DÃ©marre tous les services
	@echo "$(BLUE)ðŸš€ DÃ©marrage des services...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ… Services dÃ©marrÃ©s$(NC)"
	@echo "$(YELLOW)Frontend: http://localhost:3000$(NC)"
	@echo "$(YELLOW)Backend API: http://localhost:8000$(NC)"
	@echo "$(YELLOW)API Docs: http://localhost:8000/docs$(NC)"
	@echo "$(YELLOW)Adminer: http://localhost:8080$(NC)"

stop: ## ArrÃªte tous les services
	@echo "$(BLUE)ðŸ›‘ ArrÃªt des services...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) down
	@echo "$(GREEN)âœ… Services arrÃªtÃ©s$(NC)"

restart: stop start ## RedÃ©marre tous les services

logs: ## Affiche les logs de tous les services
	@docker-compose -f $(COMPOSE_FILE) logs -f

logs-backend: ## Affiche les logs du backend
	@docker-compose -f $(COMPOSE_FILE) logs -f backend

logs-frontend: ## Affiche les logs du frontend
	@docker-compose -f $(COMPOSE_FILE) logs -f frontend

logs-db: ## Affiche les logs de la base de donnÃ©es
	@docker-compose -f $(COMPOSE_FILE) logs -f postgres

test: ## Lance les tests
	@echo "$(BLUE)ðŸ§ª Lancement des tests...$(NC)"
	@cd $(BACKEND_DIR) && python -m pytest tests/ -v
	@cd $(FRONTEND_DIR) && npm run test
	@echo "$(GREEN)âœ… Tests terminÃ©s$(NC)"

test-backend: ## Lance les tests backend uniquement
	@echo "$(BLUE)ðŸ§ª Tests backend...$(NC)"
	@cd $(BACKEND_DIR) && python -m pytest tests/ -v

test-frontend: ## Lance les tests frontend uniquement
	@echo "$(BLUE)ðŸ§ª Tests frontend...$(NC)"
	@cd $(FRONTEND_DIR) && npm run test

lint: ## VÃ©rification du code (linting)
	@echo "$(BLUE)ðŸ” VÃ©rification du code...$(NC)"
	@cd $(BACKEND_DIR) && ruff check . && black --check .
	@cd $(FRONTEND_DIR) && npm run lint
	@echo "$(GREEN)âœ… Code vÃ©rifiÃ©$(NC)"

format: ## Formatage du code
	@echo "$(BLUE)âœ¨ Formatage du code...$(NC)"
	@cd $(BACKEND_DIR) && black .
	@cd $(FRONTEND_DIR) && npm run format
	@echo "$(GREEN)âœ… Code formatÃ©$(NC)"

type-check: ## VÃ©rification des types TypeScript
	@echo "$(BLUE)ðŸ” VÃ©rification des types...$(NC)"
	@cd $(FRONTEND_DIR) && npm run type-check
	@echo "$(GREEN)âœ… Types vÃ©rifiÃ©s$(NC)"

build: ## Build des applications pour production
	@echo "$(BLUE)ðŸ—ï¸  Build des applications...$(NC)"
	@cd $(FRONTEND_DIR) && npm run build
	@echo "$(GREEN)âœ… Build terminÃ©$(NC)"

db-migrate: ## Applique les migrations de base de donnÃ©es
	@echo "$(BLUE)ðŸ—„ï¸  Application des migrations...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) exec backend alembic upgrade head
	@echo "$(GREEN)âœ… Migrations appliquÃ©es$(NC)"

db-reset: ## Remet Ã  zÃ©ro la base de donnÃ©es
	@echo "$(RED)âš ï¸  Remise Ã  zÃ©ro de la base de donnÃ©es...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) down -v
	@docker volume rm lexo_postgres_data || true
	@docker-compose -f $(COMPOSE_FILE) up -d postgres
	@sleep 5
	@docker-compose -f $(COMPOSE_FILE) exec backend alembic upgrade head
	@echo "$(GREEN)âœ… Base de donnÃ©es remise Ã  zÃ©ro$(NC)"

dev-backend: ## Lance le backend en mode dÃ©veloppement (local)
	@echo "$(BLUE)ðŸš€ DÃ©marrage backend local...$(NC)"
	@cd $(BACKEND_DIR) && source venv/bin/activate && uvicorn main:app --reload --host 0.0.0.0 --port 8000

dev-frontend: ## Lance le frontend en mode dÃ©veloppement (local)
	@echo "$(BLUE)ðŸš€ DÃ©marrage frontend local...$(NC)"
	@cd $(FRONTEND_DIR) && npm run dev

status: ## Affiche le statut des services
	@echo "$(BLUE)ðŸ“Š Statut des services:$(NC)"
	@docker-compose -f $(COMPOSE_FILE) ps

health: ## VÃ©rifie la santÃ© des services
	@echo "$(BLUE)ðŸ¥ VÃ©rification de la santÃ© des services...$(NC)"
	@curl -s http://localhost:8000/api/v1/health || echo "$(RED)âŒ Backend indisponible$(NC)"
	@curl -s http://localhost:3000 > /dev/null && echo "$(GREEN)âœ… Frontend OK$(NC)" || echo "$(RED)âŒ Frontend indisponible$(NC)"

# Commandes avancÃ©es
backup-db: ## Sauvegarde la base de donnÃ©es
	@echo "$(BLUE)ðŸ’¾ Sauvegarde de la base de donnÃ©es...$(NC)"
	@mkdir -p backups
	@docker-compose -f $(COMPOSE_FILE) exec postgres pg_dump -U lexo lexo_dev > backups/db_backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)âœ… Sauvegarde terminÃ©e$(NC)"

restore-db: ## Restaure la base de donnÃ©es (usage: make restore-db FILE=backup.sql)
	@echo "$(BLUE)ðŸ“¥ Restauration de la base de donnÃ©es...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) exec -T postgres psql -U lexo lexo_dev < $(FILE)
	@echo "$(GREEN)âœ… Restauration terminÃ©e$(NC)"

update: ## Met Ã  jour les dÃ©pendances
	@echo "$(BLUE)ðŸ”„ Mise Ã  jour des dÃ©pendances...$(NC)"
	@cd $(BACKEND_DIR) && pip install --upgrade -r requirements.txt
	@cd $(FRONTEND_DIR) && npm update
	@echo "$(GREEN)âœ… DÃ©pendances mises Ã  jour$(NC)"

# Alias
up: start
down: stop
ps: status